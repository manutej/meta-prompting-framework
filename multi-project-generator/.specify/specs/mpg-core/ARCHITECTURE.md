# MPG Architecture Diagrams

**Version**: 1.0.0
**Date**: 2026-01-04
**Status**: Approved for MVP

---

## 1. System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USER INTERFACES                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────┐              ┌─────────────────────────────────┐ │
│   │    CLI Interface    │              │      MCP Server Interface       │ │
│   │  (Commander.js 14)  │              │    (@mcp/sdk 1.25.1)            │ │
│   │                     │              │                                 │ │
│   │  $ mpg list         │              │  Tools:                         │ │
│   │  $ mpg plan         │◄────────────►│  • list_sites                   │ │
│   │  $ mpg apply        │  Shared      │  • plan_sites                   │ │
│   │  $ mpg status       │  Core        │  • apply_sites                  │ │
│   │  $ mpg validate     │              │  • get_status                   │ │
│   └─────────────────────┘              └─────────────────────────────────┘ │
│              │                                        │                     │
└──────────────┼────────────────────────────────────────┼─────────────────────┘
               │                                        │
               ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CORE ENGINE                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐│
│   │  Config Loader  │  │  Plan Generator │  │     Execution Engine        ││
│   │                 │  │                 │  │                             ││
│   │  YAML → Parse   │─►│  Validate       │─►│  Template Download (giget)  ││
│   │  Zod Validate   │  │  Resolve Deps   │  │  Variable Sub (Handlebars)  ││
│   │  Type Inference │  │  Build Graph    │  │  Parallel Exec (p-queue)    ││
│   └─────────────────┘  └─────────────────┘  └─────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           OUTPUT LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Turborepo 2.7 Monorepo                            │  │
│   │                                                                      │  │
│   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │  │
│   │   │ site-1  │  │ site-2  │  │ site-3  │  │   ...   │  │ site-n  │  │  │
│   │   │ (Next)  │  │ (Astro) │  │ (Remix) │  │         │  │ (Nuxt)  │  │  │
│   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │  │
│   │                                                                      │  │
│   │   ┌─────────────────────────────────────────────────────────────┐   │  │
│   │   │                    packages/                                 │   │  │
│   │   │   ui/  │  config/  │  utils/  │  types/                     │   │  │
│   │   └─────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Data Flow Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           INPUT STAGE                                         │
└──────────────────────────────────────────────────────────────────────────────┘

     sites.yaml                    Templates                    Environment
         │                             │                             │
         ▼                             ▼                             ▼
    ┌─────────┐                  ┌───────────┐                 ┌───────────┐
    │  YAML   │                  │  GitHub   │                 │   .env    │
    │ Parser  │                  │  Repos    │                 │  Secrets  │
    └────┬────┘                  └─────┬─────┘                 └─────┬─────┘
         │                             │                             │
         ▼                             ▼                             ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          VALIDATION STAGE                                     │
│                                                                               │
│   ┌────────────────────────────────────────────────────────────────────────┐ │
│   │                         Zod 4.3.5 Schema Validation                     │ │
│   │                                                                         │ │
│   │   SiteConfigSchema ─────► WorkflowSchema ─────► VariablesSchema        │ │
│   │          │                      │                      │                │ │
│   │          ▼                      ▼                      ▼                │ │
│   │   ┌──────────┐           ┌──────────┐           ┌──────────┐           │ │
│   │   │ id       │           │ steps[]  │           │ colors   │           │ │
│   │   │ type     │           │ parallel │           │ fonts    │           │ │
│   │   │ domain   │           │ depends  │           │ content  │           │ │
│   │   │ template │           │          │           │ meta     │           │ │
│   │   └──────────┘           └──────────┘           └──────────┘           │ │
│   └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│                            Typed SiteConfig[]                                 │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           PLANNING STAGE                                      │
│                                                                               │
│   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐ │
│   │  Dependency     │    │   Execution     │    │      Resource          │ │
│   │  Resolution     │───►│   Order         │───►│      Estimation        │ │
│   │                 │    │                 │    │                        │ │
│   │  • Template     │    │  • Parallel     │    │  • Disk space          │ │
│   │  • Shared pkgs  │    │  • Sequential   │    │  • Memory              │ │
│   │  • Build order  │    │  • Priority     │    │  • Network             │ │
│   └─────────────────┘    └─────────────────┘    └─────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│                             ExecutionPlan                                     │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          EXECUTION STAGE                                      │
│                                                                               │
│                        ┌─────────────────────┐                               │
│                        │   p-queue 9.0.1     │                               │
│                        │   Task Orchestrator │                               │
│                        └──────────┬──────────┘                               │
│                                   │                                          │
│           ┌───────────────────────┼───────────────────────┐                 │
│           │                       │                       │                 │
│           ▼                       ▼                       ▼                 │
│   ┌───────────────┐       ┌───────────────┐       ┌───────────────┐        │
│   │   Worker 1    │       │   Worker 2    │       │   Worker N    │        │
│   │               │       │               │       │               │        │
│   │ 1. Download   │       │ 1. Download   │       │ 1. Download   │        │
│   │ 2. Substitute │       │ 2. Substitute │       │ 2. Substitute │        │
│   │ 3. Configure  │       │ 3. Configure  │       │ 3. Configure  │        │
│   │ 4. Validate   │       │ 4. Validate   │       │ 4. Validate   │        │
│   └───────────────┘       └───────────────┘       └───────────────┘        │
│           │                       │                       │                 │
│           └───────────────────────┴───────────────────────┘                 │
│                                   │                                          │
│                                   ▼                                          │
│                          Generated Sites[]                                   │
└──────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           OUTPUT STAGE                                        │
│                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Turborepo Monorepo                               │   │
│   │                                                                      │   │
│   │   turbo.json ◄─── Generated configuration                           │   │
│   │   pnpm-workspace.yaml ◄─── Workspace config                         │   │
│   │   apps/* ◄─── Generated sites                                       │   │
│   │   packages/* ◄─── Shared packages                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Component Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                                  packages/                                    │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                           @mpg/core                                     │  │
│  │                                                                         │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │  │
│  │  │   config/    │  │   plan/      │  │   execute/   │  │  output/   │ │  │
│  │  │              │  │              │  │              │  │            │ │  │
│  │  │ • loader.ts  │  │ • planner.ts │  │ • runner.ts  │  │ • writer.ts│ │  │
│  │  │ • schema.ts  │  │ • graph.ts   │  │ • queue.ts   │  │ • turbo.ts │ │  │
│  │  │ • types.ts   │  │ • resolver.ts│  │ • worker.ts  │  │ • pnpm.ts  │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                        │
│                                      │ uses                                   │
│                                      ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                          @mpg/templates                                 │  │
│  │                                                                         │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │  │
│  │  │  download/   │  │  process/    │  │  validate/   │  │  registry/ │ │  │
│  │  │              │  │              │  │              │  │            │ │  │
│  │  │ • giget.ts   │  │ • hbs.ts     │  │ • schema.ts  │  │ • local.ts │ │  │
│  │  │ • cache.ts   │  │ • rename.ts  │  │ • files.ts   │  │ • remote.ts│ │  │
│  │  │ • auth.ts    │  │ • binary.ts  │  │ • deps.ts    │  │ • custom.ts│ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                        │
│                                      │ uses                                   │
│                                      ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                           @mpg/shared                                   │  │
│  │                                                                         │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │  │
│  │  │   logger/    │  │   errors/    │  │   utils/     │  │  types/    │ │  │
│  │  │              │  │              │  │              │  │            │ │  │
│  │  │ • console.ts │  │ • base.ts    │  │ • fs.ts      │  │ • config.ts│ │  │
│  │  │ • file.ts    │  │ • validation │  │ • path.ts    │  │ • plan.ts  │ │  │
│  │  │ • progress.ts│  │ • execution  │  │ • async.ts   │  │ • result.ts│ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                               │
├──────────────────────────────────────────────────────────────────────────────┤
│                                   apps/                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────┐  ┌──────────────────────────────────────┐ │
│  │           @mpg/cli            │  │           @mpg/mcp-server            │ │
│  │                               │  │                                      │ │
│  │  ┌─────────────────────────┐ │  │  ┌──────────────────────────────────┐│ │
│  │  │      commands/          │ │  │  │           tools/                 ││ │
│  │  │                         │ │  │  │                                  ││ │
│  │  │  • list.ts              │ │  │  │  • list_sites.ts                 ││ │
│  │  │  • plan.ts              │ │  │  │  • plan_sites.ts                 ││ │
│  │  │  • apply.ts             │ │  │  │  • apply_sites.ts                ││ │
│  │  │  • status.ts            │ │  │  │  • get_status.ts                 ││ │
│  │  │  • validate.ts          │ │  │  │  • validate_config.ts            ││ │
│  │  └─────────────────────────┘ │  │  └──────────────────────────────────┘│ │
│  │                               │  │                                      │ │
│  │  imports @mpg/core            │  │  imports @mpg/core                   │ │
│  └──────────────────────────────┘  └──────────────────────────────────────┘ │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Execution Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SITE GENERATION PIPELINE                             │
└─────────────────────────────────────────────────────────────────────────────┘

 ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
 │  START  │────►│  LOAD   │────►│  PLAN   │────►│ EXECUTE │────►│  DONE   │
 └─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘

                      │               │               │
                      ▼               ▼               ▼

              ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
              │ Parse YAML   │ │ Build Graph  │ │ p-queue      │
              │ Validate Zod │ │ Resolve Deps │ │ Orchestrates │
              │ Infer Types  │ │ Set Priority │ │ Workers      │
              └──────────────┘ └──────────────┘ └──────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          PER-SITE WORKER PIPELINE                            │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌───────────────────────────────────────────────────────────────────────┐
  │                         Worker Thread / Promise                        │
  └───────────────────────────────────────────────────────────────────────┘
                                     │
        ┌────────────────────────────┼────────────────────────────┐
        │                            │                            │
        ▼                            ▼                            ▼
  ┌───────────┐               ┌───────────┐               ┌───────────┐
  │  PHASE 1  │               │  PHASE 2  │               │  PHASE 3  │
  │  DOWNLOAD │               │  PROCESS  │               │  FINALIZE │
  └─────┬─────┘               └─────┬─────┘               └─────┬─────┘
        │                           │                           │
        ▼                           ▼                           ▼
  ┌───────────┐               ┌───────────┐               ┌───────────┐
  │ giget     │               │ Handlebars│               │ Validate  │
  │ download  │               │ substitute│               │ structure │
  │ template  │               │ variables │               │           │
  └─────┬─────┘               └─────┬─────┘               └─────┬─────┘
        │                           │                           │
        ▼                           ▼                           ▼
  ┌───────────┐               ┌───────────┐               ┌───────────┐
  │ Extract   │               │ Rename    │               │ Update    │
  │ to temp   │               │ __name__  │               │ package   │
  │ directory │               │ patterns  │               │ .json     │
  └─────┬─────┘               └─────┬─────┘               └─────┬─────┘
        │                           │                           │
        ▼                           ▼                           ▼
  ┌───────────┐               ┌───────────┐               ┌───────────┐
  │ Cache for │               │ Process   │               │ Move to   │
  │ future    │               │ binary    │               │ final     │
  │ use       │               │ files     │               │ location  │
  └───────────┘               └───────────┘               └───────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                          ERROR HANDLING FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
  │  Error  │────►│   Retry?    │────►│   Log       │────►│  Continue   │
  │ Occurs  │     │  (p-retry)  │     │   Error     │     │  Others     │
  └─────────┘     └──────┬──────┘     └─────────────┘     └─────────────┘
                         │
                         │ Max retries exceeded
                         ▼
                  ┌─────────────┐
                  │   Mark      │
                  │   Failed    │
                  │             │
                  │ • Log error │
                  │ • Skip site │
                  │ • Report    │
                  └─────────────┘
```

---

## 5. MCP Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MCP ECOSYSTEM INTEGRATION                            │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌───────────────────────────────────────────────────────────────────────────┐
  │                           AI CLIENTS                                       │
  │                                                                            │
  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐  │
  │   │ Claude Code │   │  ChatGPT    │   │   Cursor    │   │   Custom    │  │
  │   │             │   │  (OpenAI)   │   │             │   │   Client    │  │
  │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘  │
  │          │                 │                 │                 │          │
  └──────────┼─────────────────┼─────────────────┼─────────────────┼──────────┘
             │                 │                 │                 │
             │    MCP Protocol (JSON-RPC 2.0)    │                 │
             └─────────────────┬─────────────────┘                 │
                               │                                   │
                               ▼                                   ▼
  ┌───────────────────────────────────────────────────────────────────────────┐
  │                         MPG MCP SERVER                                     │
  │                     @modelcontextprotocol/sdk 1.25.1                       │
  │                                                                            │
  │   Transport Layer                                                          │
  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
  │   │  stdio          │  │  HTTP           │  │  SSE (deprecated)       │  │
  │   │  (local)        │  │  (remote)       │  │                         │  │
  │   └────────┬────────┘  └────────┬────────┘  └─────────────────────────┘  │
  │            │                    │                                         │
  │            └──────────┬─────────┘                                         │
  │                       │                                                   │
  │                       ▼                                                   │
  │   ┌───────────────────────────────────────────────────────────────────┐  │
  │   │                      REQUEST HANDLER                               │  │
  │   │                                                                    │  │
  │   │   tools/list ────► Returns tool definitions with JSON Schema      │  │
  │   │   tools/call ────► Executes tool and returns results              │  │
  │   └───────────────────────────────────────────────────────────────────┘  │
  │                       │                                                   │
  │                       ▼                                                   │
  │   ┌───────────────────────────────────────────────────────────────────┐  │
  │   │                         TOOL HANDLERS                              │  │
  │   │                                                                    │  │
  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │  │
  │   │  │ list_sites  │  │ plan_sites  │  │ apply_sites │  │ status   │ │  │
  │   │  │             │  │             │  │             │  │          │ │  │
  │   │  │ Read config │  │ Dry run     │  │ Execute     │  │ Progress │ │  │
  │   │  │ Return list │  │ Show plan   │  │ Generation  │  │ Report   │ │  │
  │   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────┬─────┘ │  │
  │   │         │                │                │               │       │  │
  │   └─────────┼────────────────┼────────────────┼───────────────┼───────┘  │
  │             │                │                │               │          │
  │             └────────────────┴────────────────┴───────────────┘          │
  │                                      │                                    │
  │                                      ▼                                    │
  │                              @mpg/core                                    │
  │                          (Shared with CLI)                                │
  └───────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         MCP TOOL SCHEMAS                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  list_sites                    plan_sites                    apply_sites
  ┌─────────────────────┐       ┌─────────────────────┐       ┌─────────────────────┐
  │ Input:              │       │ Input:              │       │ Input:              │
  │ {                   │       │ {                   │       │ {                   │
  │   type?: enum       │       │   sites?: string[]  │       │   concurrency?: num │
  │   format?: enum     │       │   dryRun?: bool     │       │   force?: bool      │
  │ }                   │       │ }                   │       │   sites?: string[]  │
  │                     │       │                     │       │ }                   │
  │ Output:             │       │ Output:             │       │                     │
  │ {                   │       │ {                   │       │ Output:             │
  │   sites: Site[]     │       │   plan: Step[]      │       │ {                   │
  │   count: number     │       │   warnings: Warn[]  │       │   results: Result[] │
  │ }                   │       │   estimate: Est     │       │   summary: Summary  │
  └─────────────────────┘       │ }                   │       │ }                   │
                                └─────────────────────┘       └─────────────────────┘
```

---

## 6. Template System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TEMPLATE REGISTRY & FLOW                              │
└─────────────────────────────────────────────────────────────────────────────┘

  Template Sources
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌────────────┐ │
  │   │   GitHub    │   │   GitLab    │   │    Local    │   │   Custom   │ │
  │   │   Repos     │   │   Repos     │   │   Directory │   │   Registry │ │
  │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └─────┬──────┘ │
  │          │                 │                 │                 │        │
  │          └─────────────────┴─────────────────┴─────────────────┘        │
  │                                      │                                   │
  │                                      ▼                                   │
  │                          ┌─────────────────────┐                        │
  │                          │   Template Registry │                        │
  │                          │                     │                        │
  │                          │ • Resolution        │                        │
  │                          │ • Versioning        │                        │
  │                          │ • Caching           │                        │
  │                          └──────────┬──────────┘                        │
  │                                     │                                    │
  └─────────────────────────────────────┼────────────────────────────────────┘
                                        │
                                        ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                         TEMPLATE STRUCTURE                               │
  │                                                                          │
  │   template/                                                              │
  │   ├── template.json          # Template metadata                        │
  │   │   {                                                                  │
  │   │     "name": "next-marketing",                                       │
  │   │     "framework": "next",                                            │
  │   │     "version": "1.0.0",                                             │
  │   │     "variables": {                                                  │
  │   │       "siteName": { "type": "string", "required": true },           │
  │   │       "primaryColor": { "type": "string", "default": "#000" }       │
  │   │     }                                                                │
  │   │   }                                                                  │
  │   │                                                                      │
  │   ├── src/                                                               │
  │   │   ├── app/                                                          │
  │   │   │   ├── page.tsx       # {{siteName}} in content                  │
  │   │   │   └── layout.tsx     # {{primaryColor}} in styles               │
  │   │   └── components/                                                   │
  │   │       └── __name__.tsx   # Renamed based on siteName                │
  │   │                                                                      │
  │   ├── package.json           # {{siteName}} in name field               │
  │   └── tailwind.config.ts     # {{primaryColor}} in theme                │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                       TEMPLATE PROCESSING                                │
  │                                                                          │
  │   Step 1: Download (giget)                                              │
  │   ┌────────────────────────────────────────────────────────────────┐   │
  │   │  await downloadTemplate('github:org/next-marketing', {          │   │
  │   │    dir: '.mpg-cache/templates/next-marketing',                  │   │
  │   │    preferOffline: true                                          │   │
  │   │  });                                                            │   │
  │   └────────────────────────────────────────────────────────────────┘   │
  │                                                                          │
  │   Step 2: Copy to Output                                                │
  │   ┌────────────────────────────────────────────────────────────────┐   │
  │   │  Copy template → apps/{siteId}/                                 │   │
  │   └────────────────────────────────────────────────────────────────┘   │
  │                                                                          │
  │   Step 3: Variable Substitution (Handlebars)                            │
  │   ┌────────────────────────────────────────────────────────────────┐   │
  │   │  For each text file:                                            │   │
  │   │    content = Handlebars.compile(fileContent)(variables)         │   │
  │   │                                                                 │   │
  │   │  Example:                                                       │   │
  │   │    "Welcome to {{siteName}}" → "Welcome to Acme Corp"          │   │
  │   └────────────────────────────────────────────────────────────────┘   │
  │                                                                          │
  │   Step 4: File Renaming                                                 │
  │   ┌────────────────────────────────────────────────────────────────┐   │
  │   │  __name__.tsx → acme-corp.tsx                                   │   │
  │   │  __Name__.tsx → AcmeCorp.tsx                                    │   │
  │   │  __NAME__.tsx → ACME_CORP.tsx                                   │   │
  │   └────────────────────────────────────────────────────────────────┘   │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Monorepo Output Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      GENERATED MONOREPO STRUCTURE                            │
└─────────────────────────────────────────────────────────────────────────────┘

  generated-sites/                    # Root of generated monorepo
  │
  ├── turbo.json                      # Turborepo configuration
  │   {
  │     "tasks": {
  │       "build": { "dependsOn": ["^build"] },
  │       "dev": { "cache": false, "persistent": true }
  │     }
  │   }
  │
  ├── pnpm-workspace.yaml             # pnpm workspace definition
  │   packages:
  │     - 'apps/*'
  │     - 'packages/*'
  │
  ├── package.json                    # Root package.json
  │   {
  │     "name": "generated-sites",
  │     "packageManager": "pnpm@9.1.0",
  │     "scripts": {
  │       "build": "turbo run build",
  │       "dev": "turbo run dev"
  │     }
  │   }
  │
  ├── apps/                           # Generated sites
  │   │
  │   ├── site-alpha/                 # Site 1
  │   │   ├── package.json
  │   │   ├── turbo.json              # Per-site Turborepo config
  │   │   ├── next.config.js
  │   │   └── src/
  │   │
  │   ├── site-beta/                  # Site 2
  │   │   ├── package.json
  │   │   ├── turbo.json
  │   │   ├── astro.config.mjs
  │   │   └── src/
  │   │
  │   └── site-gamma/                 # Site 3
  │       ├── package.json
  │       ├── turbo.json
  │       ├── remix.config.js
  │       └── app/
  │
  └── packages/                       # Shared packages
      │
      ├── ui/                         # Shared UI components
      │   ├── package.json
      │   └── src/
      │       ├── Button.tsx
      │       ├── Card.tsx
      │       └── index.ts
      │
      ├── config/                     # Shared configurations
      │   ├── package.json
      │   ├── eslint/
      │   ├── typescript/
      │   └── tailwind/
      │
      └── utils/                      # Shared utilities
          ├── package.json
          └── src/
              ├── formatting.ts
              └── validation.ts


  ┌─────────────────────────────────────────────────────────────────────────┐
  │                     DEPENDENCY GRAPH                                     │
  │                                                                          │
  │                      ┌─────────────┐                                    │
  │                      │   @mpg/ui   │                                    │
  │                      └──────┬──────┘                                    │
  │                             │                                            │
  │          ┌──────────────────┼──────────────────┐                        │
  │          │                  │                  │                        │
  │          ▼                  ▼                  ▼                        │
  │   ┌────────────┐     ┌────────────┐     ┌────────────┐                 │
  │   │ site-alpha │     │ site-beta  │     │ site-gamma │                 │
  │   └──────┬─────┘     └──────┬─────┘     └──────┬─────┘                 │
  │          │                  │                  │                        │
  │          └──────────────────┼──────────────────┘                        │
  │                             │                                            │
  │                             ▼                                            │
  │                      ┌─────────────┐                                    │
  │                      │ @mpg/config │                                    │
  │                      └──────┬──────┘                                    │
  │                             │                                            │
  │                             ▼                                            │
  │                      ┌─────────────┐                                    │
  │                      │ @mpg/utils  │                                    │
  │                      └─────────────┘                                    │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Concurrency Model

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        P-QUEUE CONCURRENCY MODEL                             │
└─────────────────────────────────────────────────────────────────────────────┘

  Configuration
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   const queue = new PQueue({                                            │
  │     concurrency: 20,        // 20 sites at once                         │
  │     intervalCap: 50,        // Max 50 per interval                      │
  │     interval: 60000,        // 1 minute                                 │
  │     timeout: 300000         // 5 min per site                           │
  │   });                                                                    │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘

  Execution Timeline (20 concurrent, 50 sites total)
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   Time ──────────────────────────────────────────────────────────────►  │
  │                                                                          │
  │   T0     T1     T2     T3     T4     T5     T6     T7                   │
  │   │      │      │      │      │      │      │      │                    │
  │   ▼      ▼      ▼      ▼      ▼      ▼      ▼      ▼                    │
  │                                                                          │
  │   ┌──────────────────────────────────────────────────────────────────┐  │
  │   │ Batch 1 (sites 1-20)                                              │  │
  │   │ ████████████████████                                              │  │
  │   └──────────────────────────────────────────────────────────────────┘  │
  │                                                                          │
  │          ┌──────────────────────────────────────────────────────────┐   │
  │          │ Batch 2 (sites 21-40) - starts as slots free up          │   │
  │          │ ████████████████████                                      │   │
  │          └──────────────────────────────────────────────────────────┘   │
  │                                                                          │
  │                 ┌──────────────────────────────────────┐                │
  │                 │ Batch 3 (sites 41-50)                │                │
  │                 │ ██████████                           │                │
  │                 └──────────────────────────────────────┘                │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘

  Priority Queue (Higher = First)
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   Priority 10: ████ Critical sites (production)                         │
  │   Priority 5:  ████████ Important sites (staging)                       │
  │   Priority 1:  ████████████████ Normal sites (development)              │
  │   Priority 0:  ██████ Low priority (experimental)                       │
  │                                                                          │
  │   Execution Order: P10 → P5 → P1 → P0                                   │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘

  State Machine
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │                    ┌─────────┐                                          │
  │            ┌──────►│ QUEUED  │◄──────┐                                  │
  │            │       └────┬────┘       │                                  │
  │            │            │            │                                  │
  │            │ pause()    │ slot       │ add()                            │
  │            │            │ available  │                                  │
  │            │            ▼            │                                  │
  │       ┌────┴────┐  ┌─────────┐  ┌────┴────┐                            │
  │       │ PAUSED  │◄─┤ RUNNING ├─►│  DONE   │                            │
  │       └────┬────┘  └────┬────┘  └─────────┘                            │
  │            │            │                                               │
  │            │ start()    │ error                                         │
  │            │            ▼                                               │
  │            │       ┌─────────┐                                          │
  │            └──────►│ FAILED  │──────► retry? ──► QUEUED                 │
  │                    └─────────┘                                          │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Configuration Schema

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ZOD SCHEMA HIERARCHY                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                          MPGConfigSchema                                 │
  │                                                                          │
  │   {                                                                      │
  │     version: z.literal('1.0'),                                          │
  │     output: OutputSchema,                                                │
  │     defaults: DefaultsSchema,                                            │
  │     workflows: z.record(WorkflowSchema),                                 │
  │     templates: z.record(TemplateSchema),                                 │
  │     sites: z.array(SiteSchema)                                          │
  │   }                                                                      │
  │                                                                          │
  └───────────────────────────────────────────────────────────────────────────┘
                                     │
          ┌──────────────────────────┼──────────────────────────┐
          │                          │                          │
          ▼                          ▼                          ▼
  ┌───────────────┐          ┌───────────────┐          ┌───────────────┐
  │ OutputSchema  │          │DefaultsSchema │          │  SiteSchema   │
  │               │          │               │          │               │
  │ {             │          │ {             │          │ {             │
  │   dir: string │          │   template:   │          │   id: string  │
  │   clean: bool │          │     string    │          │   name: string│
  │   monorepo:   │          │   framework:  │          │   domain: url │
  │     bool      │          │     enum      │          │   template:   │
  │ }             │          │   workflow:   │          │     string    │
  │               │          │     string    │          │   workflow:   │
  └───────────────┘          │ }             │          │     string    │
                             │               │          │   variables:  │
                             └───────────────┘          │     record    │
                                                        │   priority:   │
                                                        │     number    │
                                                        │ }             │
                                                        └───────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │                         TYPE INFERENCE                                   │
  │                                                                          │
  │   // Schema definition                                                   │
  │   const SiteSchema = z.object({                                         │
  │     id: z.string().min(1).max(50),                                      │
  │     name: z.string(),                                                   │
  │     domain: z.string().url(),                                           │
  │     template: z.string().default('default'),                            │
  │     workflow: z.string().default('standard'),                           │
  │     priority: z.number().int().min(0).max(10).default(0),               │
  │     variables: z.record(z.unknown()).optional()                         │
  │   });                                                                    │
  │                                                                          │
  │   // Automatic type inference                                            │
  │   type Site = z.infer<typeof SiteSchema>;                               │
  │   // Result:                                                             │
  │   // {                                                                   │
  │   //   id: string;                                                       │
  │   //   name: string;                                                     │
  │   //   domain: string;                                                   │
  │   //   template: string;                                                 │
  │   //   workflow: string;                                                 │
  │   //   priority: number;                                                 │
  │   //   variables?: Record<string, unknown>;                              │
  │   // }                                                                   │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DEPLOYMENT PIPELINE                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Development Machine
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   $ mpg apply                                                           │
  │       │                                                                  │
  │       ▼                                                                  │
  │   ┌─────────────────┐                                                   │
  │   │ Generate Sites  │                                                   │
  │   │ (Local Monorepo)│                                                   │
  │   └────────┬────────┘                                                   │
  │            │                                                             │
  │            ▼                                                             │
  │   ┌─────────────────┐     ┌─────────────────┐                          │
  │   │   Git Commit    │────►│   Git Push      │                          │
  │   │                 │     │   (to remote)   │                          │
  │   └─────────────────┘     └────────┬────────┘                          │
  │                                    │                                     │
  └────────────────────────────────────┼─────────────────────────────────────┘
                                       │
                                       ▼
  CI/CD Pipeline (GitHub Actions / Vercel)
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐  │
  │   │    Trigger      │────►│   Turbo Build   │────►│    Deploy       │  │
  │   │    (on push)    │     │   (cached)      │     │                 │  │
  │   └─────────────────┘     └─────────────────┘     └─────────────────┘  │
  │                                    │                                     │
  │                                    ▼                                     │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │                    Turborepo Remote Cache                        │   │
  │   │                                                                  │   │
  │   │   • Vercel Remote Cache (free)                                  │   │
  │   │   • S3-compatible self-hosted                                   │   │
  │   │   • Skip unchanged sites                                        │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                    │                                     │
  │                                    ▼                                     │
  │   ┌─────────────────────────────────────────────────────────────────┐   │
  │   │                    Parallel Site Deployment                      │   │
  │   │                                                                  │   │
  │   │   site-alpha ──► Vercel (Next.js)                               │   │
  │   │   site-beta ───► Netlify (Astro)                                │   │
  │   │   site-gamma ──► AWS (Remix)                                    │   │
  │   │   ...                                                            │   │
  │   └─────────────────────────────────────────────────────────────────┘   │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘

  Production (Multi-Cloud)
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                          │
  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌───────────┐  │
  │   │   Vercel    │   │   Netlify   │   │     AWS     │   │  Custom   │  │
  │   │             │   │             │   │             │   │           │  │
  │   │ site-alpha  │   │ site-beta   │   │ site-gamma  │   │ site-n    │  │
  │   │ site-delta  │   │ site-eta    │   │ site-theta  │   │           │  │
  │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └─────┬─────┘  │
  │          │                 │                 │                 │        │
  │          └─────────────────┴─────────────────┴─────────────────┘        │
  │                                      │                                   │
  │                                      ▼                                   │
  │                            ┌─────────────────┐                          │
  │                            │   DNS / CDN     │                          │
  │                            │   (Cloudflare)  │                          │
  │                            └─────────────────┘                          │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2026-01-04 | MPG Team | Initial architecture diagrams |

---

*These diagrams represent the MVP architecture. Future phases may introduce additional complexity.*
