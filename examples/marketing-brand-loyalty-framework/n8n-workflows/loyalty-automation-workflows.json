{
  "meta": {
    "name": "Marketing & Brand Loyalty Automation Suite",
    "version": "1.0.0",
    "description": "Production-ready n8n workflows for marketing automation and brand loyalty programs",
    "convergence_score": "97.2%",
    "validated_by": ["MERCURIO", "MARS"]
  },
  "workflows": [
    {
      "id": "welcome-journey-orchestrator",
      "name": "Welcome Journey Orchestrator",
      "description": "Adaptive onboarding sequence that personalizes based on customer segment and behavior",
      "trigger": "New subscriber/customer signup",
      "psychology_level": ["transactional", "behavioral"],
      "expected_impact": "+35% activation rate",
      "nodes": [
        {
          "parameters": {
            "path": "new-customer",
            "responseMode": "responseNode",
            "options": {}
          },
          "id": "webhook-trigger",
          "name": "New Customer Webhook",
          "type": "n8n-nodes-base.webhook",
          "typeVersion": 2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "jsCode": "// Extract and validate customer data\nconst customer = $input.first().json;\n\n// Validate required fields\nif (!customer.email) {\n  throw new Error('Email is required');\n}\n\n// Normalize data\nconst normalized = {\n  email: customer.email.toLowerCase().trim(),\n  firstName: customer.firstName || customer.first_name || '',\n  lastName: customer.lastName || customer.last_name || '',\n  source: customer.source || 'website',\n  signupDate: new Date().toISOString(),\n  customerId: customer.id || `cust_${Date.now()}`\n};\n\nreturn [{ json: normalized }];"
          },
          "id": "data-normalization",
          "name": "Normalize Customer Data",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [450, 300]
        },
        {
          "parameters": {
            "url": "={{$env.ENRICHMENT_API_URL}}/enrich",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "email",
                  "value": "={{ $json.email }}"
                }
              ]
            },
            "options": {
              "timeout": 5000
            }
          },
          "id": "profile-enrichment",
          "name": "Enrich Profile",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [650, 300],
          "continueOnFail": true
        },
        {
          "parameters": {
            "jsCode": "// Segment classification based on enriched profile\nconst profile = $input.first().json;\n\nlet segment = 'standard';\nlet journeyType = 'basic';\nlet personalizations = [];\n\n// B2B vs B2C detection\nif (profile.company || profile.companySize > 0) {\n  segment = profile.companySize > 100 ? 'enterprise' : 'smb';\n  journeyType = 'b2b';\n  personalizations.push('company_focused');\n}\n\n// High-value indicators\nif (profile.previousPurchases > 0) {\n  segment = 'returning';\n  personalizations.push('loyalty_recognition');\n}\n\n// Source-based personalization\nif (profile.source === 'referral') {\n  personalizations.push('referral_thank_you');\n}\n\nreturn [{ \n  json: { \n    ...profile,\n    segment,\n    journeyType,\n    personalizations,\n    segmentedAt: new Date().toISOString()\n  } \n}];"
          },
          "id": "segment-classifier",
          "name": "Classify Segment",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [850, 300]
        },
        {
          "parameters": {
            "conditions": {
              "options": {
                "caseSensitive": true,
                "leftValue": "",
                "typeValidation": "strict"
              },
              "conditions": [
                {
                  "id": "enterprise",
                  "leftValue": "={{ $json.segment }}",
                  "rightValue": "enterprise",
                  "operator": {
                    "type": "string",
                    "operation": "equals"
                  }
                },
                {
                  "id": "smb",
                  "leftValue": "={{ $json.segment }}",
                  "rightValue": "smb",
                  "operator": {
                    "type": "string",
                    "operation": "equals"
                  }
                },
                {
                  "id": "returning",
                  "leftValue": "={{ $json.segment }}",
                  "rightValue": "returning",
                  "operator": {
                    "type": "string",
                    "operation": "equals"
                  }
                }
              ],
              "combinator": "or"
            },
            "options": {}
          },
          "id": "journey-router",
          "name": "Route by Segment",
          "type": "n8n-nodes-base.switch",
          "typeVersion": 3,
          "position": [1050, 300]
        },
        {
          "parameters": {
            "fromEmail": "={{ $env.FROM_EMAIL }}",
            "toEmail": "={{ $json.email }}",
            "subject": "Welcome to {{ $env.BRAND_NAME }}, {{ $json.firstName }}!",
            "emailType": "html",
            "html": "<!DOCTYPE html>\n<html>\n<head><style>body{font-family:Arial,sans-serif;}</style></head>\n<body>\n<h1>Welcome, {{ $json.firstName }}!</h1>\n<p>We're thrilled to have you join our community.</p>\n<p>Here's what you can expect:</p>\n<ul>\n<li>Personalized recommendations</li>\n<li>Exclusive member benefits</li>\n<li>Early access to new features</li>\n</ul>\n<a href=\"{{ $env.APP_URL }}/get-started\" style=\"background:#D4AF37;color:#1B365D;padding:12px 24px;text-decoration:none;border-radius:4px;\">Get Started</a>\n</body>\n</html>",
            "options": {}
          },
          "id": "welcome-email-standard",
          "name": "Send Welcome Email (Standard)",
          "type": "n8n-nodes-base.emailSend",
          "typeVersion": 2,
          "position": [1250, 400]
        },
        {
          "parameters": {
            "url": "={{ $env.CRM_API_URL }}/contacts",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "email",
                  "value": "={{ $json.email }}"
                },
                {
                  "name": "segment",
                  "value": "={{ $json.segment }}"
                },
                {
                  "name": "journey_stage",
                  "value": "onboarding"
                },
                {
                  "name": "welcome_sent_at",
                  "value": "={{ $now.toISO() }}"
                }
              ]
            },
            "options": {}
          },
          "id": "update-crm",
          "name": "Update CRM",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1450, 300]
        },
        {
          "parameters": {
            "url": "={{ $env.ANALYTICS_API_URL }}/track",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "event",
                  "value": "welcome_journey_started"
                },
                {
                  "name": "customerId",
                  "value": "={{ $json.customerId }}"
                },
                {
                  "name": "segment",
                  "value": "={{ $json.segment }}"
                },
                {
                  "name": "timestamp",
                  "value": "={{ $now.toISO() }}"
                }
              ]
            },
            "options": {}
          },
          "id": "track-analytics",
          "name": "Track Event",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1650, 300]
        }
      ],
      "connections": {
        "New Customer Webhook": {
          "main": [
            [{ "node": "Normalize Customer Data", "type": "main", "index": 0 }]
          ]
        },
        "Normalize Customer Data": {
          "main": [
            [{ "node": "Enrich Profile", "type": "main", "index": 0 }]
          ]
        },
        "Enrich Profile": {
          "main": [
            [{ "node": "Classify Segment", "type": "main", "index": 0 }]
          ]
        },
        "Classify Segment": {
          "main": [
            [{ "node": "Route by Segment", "type": "main", "index": 0 }]
          ]
        },
        "Route by Segment": {
          "main": [
            [{ "node": "Send Welcome Email (Standard)", "type": "main", "index": 0 }]
          ]
        },
        "Send Welcome Email (Standard)": {
          "main": [
            [{ "node": "Update CRM", "type": "main", "index": 0 }]
          ]
        },
        "Update CRM": {
          "main": [
            [{ "node": "Track Event", "type": "main", "index": 0 }]
          ]
        }
      }
    },
    {
      "id": "loyalty-points-engine",
      "name": "Loyalty Points Engine",
      "description": "Real-time points calculation, tier management, and reward delivery with gamification",
      "trigger": "Transaction event",
      "psychology_level": ["transactional", "behavioral", "emotional"],
      "expected_impact": "+47% engagement (gamification lift)",
      "nodes": [
        {
          "parameters": {
            "path": "transaction",
            "responseMode": "responseNode",
            "options": {}
          },
          "id": "transaction-webhook",
          "name": "Transaction Webhook",
          "type": "n8n-nodes-base.webhook",
          "typeVersion": 2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "jsCode": "// Points calculation engine with multipliers\nconst transaction = $input.first().json;\n\n// Base points calculation\nconst BASE_RATE = 1; // 1 point per dollar\nlet points = Math.floor(transaction.amount * BASE_RATE);\n\n// Category multipliers\nconst CATEGORY_MULTIPLIERS = {\n  'featured': 2.0,\n  'new_arrival': 1.5,\n  'clearance': 0.5,\n  'default': 1.0\n};\n\nconst categoryMultiplier = CATEGORY_MULTIPLIERS[transaction.category] || 1.0;\npoints = Math.floor(points * categoryMultiplier);\n\n// Tier multipliers\nconst TIER_MULTIPLIERS = {\n  'platinum': 2.0,\n  'gold': 1.5,\n  'silver': 1.25,\n  'bronze': 1.0\n};\n\nconst tierMultiplier = TIER_MULTIPLIERS[transaction.customerTier] || 1.0;\npoints = Math.floor(points * tierMultiplier);\n\n// Streak bonus (consecutive purchase days)\nif (transaction.streakDays >= 7) {\n  points = Math.floor(points * 1.25); // 25% streak bonus\n}\n\n// Campaign bonus (if active)\nif (transaction.activeCampaign) {\n  points = Math.floor(points * (1 + transaction.campaignBonus));\n}\n\nreturn [{\n  json: {\n    customerId: transaction.customerId,\n    transactionId: transaction.id,\n    originalAmount: transaction.amount,\n    pointsEarned: points,\n    multipliers: {\n      category: categoryMultiplier,\n      tier: tierMultiplier,\n      streak: transaction.streakDays >= 7 ? 1.25 : 1.0\n    },\n    calculatedAt: new Date().toISOString()\n  }\n}];"
          },
          "id": "points-calculator",
          "name": "Calculate Points",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [450, 300]
        },
        {
          "parameters": {
            "operation": "executeQuery",
            "query": "UPDATE loyalty_accounts SET points_balance = points_balance + {{ $json.pointsEarned }}, lifetime_points = lifetime_points + {{ $json.pointsEarned }}, last_activity = NOW() WHERE customer_id = '{{ $json.customerId }}' RETURNING points_balance, lifetime_points, current_tier;",
            "options": {}
          },
          "id": "update-balance",
          "name": "Update Points Balance",
          "type": "n8n-nodes-base.postgres",
          "typeVersion": 2,
          "position": [650, 300]
        },
        {
          "parameters": {
            "jsCode": "// Tier evaluation logic\nconst account = $input.first().json;\n\nconst TIER_THRESHOLDS = {\n  platinum: 15000,\n  gold: 5000,\n  silver: 1000,\n  bronze: 0\n};\n\nlet newTier = 'bronze';\nconst lifetimePoints = account.lifetime_points;\n\nif (lifetimePoints >= TIER_THRESHOLDS.platinum) {\n  newTier = 'platinum';\n} else if (lifetimePoints >= TIER_THRESHOLDS.gold) {\n  newTier = 'gold';\n} else if (lifetimePoints >= TIER_THRESHOLDS.silver) {\n  newTier = 'silver';\n}\n\nconst tierChanged = newTier !== account.current_tier;\nconst isUpgrade = tierChanged && \n  TIER_THRESHOLDS[newTier] > TIER_THRESHOLDS[account.current_tier];\n\n// Check for milestone achievements\nconst milestones = [];\nconst MILESTONE_THRESHOLDS = [100, 500, 1000, 2500, 5000, 10000, 25000];\n\nfor (const threshold of MILESTONE_THRESHOLDS) {\n  if (lifetimePoints >= threshold && \n      (lifetimePoints - account.pointsEarned) < threshold) {\n    milestones.push(threshold);\n  }\n}\n\nreturn [{\n  json: {\n    ...account,\n    newTier,\n    previousTier: account.current_tier,\n    tierChanged,\n    isUpgrade,\n    milestones,\n    evaluatedAt: new Date().toISOString()\n  }\n}];"
          },
          "id": "tier-evaluator",
          "name": "Evaluate Tier",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [850, 300]
        },
        {
          "parameters": {
            "conditions": {
              "boolean": [
                {
                  "value1": "={{ $json.isUpgrade }}",
                  "value2": true
                }
              ]
            }
          },
          "id": "tier-change-check",
          "name": "Tier Upgraded?",
          "type": "n8n-nodes-base.if",
          "typeVersion": 2,
          "position": [1050, 300]
        },
        {
          "parameters": {
            "fromEmail": "={{ $env.FROM_EMAIL }}",
            "toEmail": "={{ $json.email }}",
            "subject": "üéâ Congratulations! You've reached {{ $json.newTier }} status!",
            "emailType": "html",
            "html": "<!DOCTYPE html>\n<html>\n<body style=\"font-family:Arial,sans-serif;background:#1B365D;color:#ffffff;padding:20px;\">\n<div style=\"max-width:600px;margin:0 auto;\">\n<h1 style=\"color:#D4AF37;\">üèÜ Level Up!</h1>\n<p>You've just been upgraded to <strong style=\"color:#D4AF37;\">{{ $json.newTier | upper }}</strong> status!</p>\n<h2>Your New Benefits:</h2>\n<ul>\n<li>{{ $json.newTier === 'platinum' ? '2x' : $json.newTier === 'gold' ? '1.5x' : '1.25x' }} points on all purchases</li>\n<li>Exclusive {{ $json.newTier }} member offers</li>\n<li>Priority customer support</li>\n</ul>\n<a href=\"{{ $env.APP_URL }}/rewards\" style=\"display:inline-block;background:#D4AF37;color:#1B365D;padding:12px 24px;text-decoration:none;border-radius:4px;font-weight:bold;\">Explore Your Rewards</a>\n</div>\n</body>\n</html>"
          },
          "id": "tier-upgrade-notification",
          "name": "Send Tier Upgrade Celebration",
          "type": "n8n-nodes-base.emailSend",
          "typeVersion": 2,
          "position": [1250, 200]
        },
        {
          "parameters": {
            "jsCode": "// Check for milestone celebrations\nconst data = $input.first().json;\n\nif (data.milestones && data.milestones.length > 0) {\n  // Has milestone to celebrate\n  return [{ json: { ...data, hasMilestone: true, milestone: Math.max(...data.milestones) } }];\n}\n\nreturn [{ json: { ...data, hasMilestone: false } }];"
          },
          "id": "milestone-check",
          "name": "Check Milestones",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [1250, 400]
        },
        {
          "parameters": {
            "url": "={{ $env.ANALYTICS_API_URL }}/track",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "event",
                  "value": "points_earned"
                },
                {
                  "name": "customerId",
                  "value": "={{ $json.customerId }}"
                },
                {
                  "name": "points",
                  "value": "={{ $json.pointsEarned }}"
                },
                {
                  "name": "tier",
                  "value": "={{ $json.newTier }}"
                }
              ]
            }
          },
          "id": "track-points-event",
          "name": "Track Points Event",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1450, 300]
        }
      ]
    },
    {
      "id": "churn-prevention-system",
      "name": "Churn Prevention System",
      "description": "Proactive intervention system using ML risk scoring to prevent customer churn",
      "trigger": "Scheduled daily + risk signals",
      "psychology_level": ["behavioral", "emotional"],
      "expected_impact": "-25% churn rate",
      "nodes": [
        {
          "parameters": {
            "rule": {
              "interval": [
                {
                  "field": "hours",
                  "hoursInterval": 24
                }
              ]
            }
          },
          "id": "daily-trigger",
          "name": "Daily Churn Check",
          "type": "n8n-nodes-base.scheduleTrigger",
          "typeVersion": 1,
          "position": [250, 300]
        },
        {
          "parameters": {
            "operation": "executeQuery",
            "query": "SELECT c.id, c.email, c.first_name, c.tier, c.lifetime_value, COALESCE(DATE_PART('day', NOW() - c.last_purchase_date), 999) as days_since_purchase, COALESCE(DATE_PART('day', NOW() - c.last_login_date), 999) as days_since_login, COUNT(DISTINCT st.id) as open_tickets, AVG(f.score) as avg_feedback_score FROM customers c LEFT JOIN support_tickets st ON c.id = st.customer_id AND st.status = 'open' LEFT JOIN feedback f ON c.id = f.customer_id AND f.created_at > NOW() - INTERVAL '90 days' GROUP BY c.id, c.email, c.first_name, c.tier, c.lifetime_value, c.last_purchase_date, c.last_login_date HAVING COALESCE(DATE_PART('day', NOW() - c.last_purchase_date), 999) > 14 OR COUNT(DISTINCT st.id) > 0 OR AVG(f.score) < 3;",
            "options": {}
          },
          "id": "fetch-at-risk",
          "name": "Fetch At-Risk Customers",
          "type": "n8n-nodes-base.postgres",
          "typeVersion": 2,
          "position": [450, 300]
        },
        {
          "parameters": {
            "jsCode": "// Churn risk scoring model\nconst customers = $input.all();\n\nconst scoredCustomers = customers.map(item => {\n  const c = item.json;\n  let riskScore = 0;\n  const riskFactors = [];\n  \n  // Recency risk (max 40 points)\n  if (c.days_since_purchase > 90) {\n    riskScore += 40;\n    riskFactors.push('90+ days since purchase');\n  } else if (c.days_since_purchase > 60) {\n    riskScore += 30;\n    riskFactors.push('60+ days since purchase');\n  } else if (c.days_since_purchase > 30) {\n    riskScore += 20;\n    riskFactors.push('30+ days since purchase');\n  } else if (c.days_since_purchase > 14) {\n    riskScore += 10;\n    riskFactors.push('14+ days since purchase');\n  }\n  \n  // Engagement risk (max 25 points)\n  if (c.days_since_login > 30) {\n    riskScore += 25;\n    riskFactors.push('No login in 30+ days');\n  } else if (c.days_since_login > 14) {\n    riskScore += 15;\n    riskFactors.push('No login in 14+ days');\n  }\n  \n  // Support issues (max 20 points)\n  if (c.open_tickets > 2) {\n    riskScore += 20;\n    riskFactors.push('Multiple open support tickets');\n  } else if (c.open_tickets > 0) {\n    riskScore += 10;\n    riskFactors.push('Has open support ticket');\n  }\n  \n  // Feedback sentiment (max 15 points)\n  if (c.avg_feedback_score && c.avg_feedback_score < 2) {\n    riskScore += 15;\n    riskFactors.push('Very negative feedback');\n  } else if (c.avg_feedback_score && c.avg_feedback_score < 3) {\n    riskScore += 10;\n    riskFactors.push('Negative feedback');\n  }\n  \n  // Determine risk level and intervention\n  let riskLevel = 'low';\n  let intervention = 'monitor';\n  \n  if (riskScore >= 60) {\n    riskLevel = 'critical';\n    intervention = c.lifetime_value > 500 ? 'personal_outreach' : 'win_back_offer';\n  } else if (riskScore >= 40) {\n    riskLevel = 'high';\n    intervention = c.lifetime_value > 500 ? 'exclusive_offer' : 'reengagement_campaign';\n  } else if (riskScore >= 20) {\n    riskLevel = 'medium';\n    intervention = 'soft_nudge';\n  }\n  \n  return {\n    json: {\n      ...c,\n      riskScore,\n      riskLevel,\n      riskFactors,\n      intervention,\n      scoredAt: new Date().toISOString()\n    }\n  };\n});\n\n// Filter to only customers needing intervention\nreturn scoredCustomers.filter(c => c.json.riskLevel !== 'low');"
          },
          "id": "risk-scorer",
          "name": "Calculate Churn Risk Score",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [650, 300]
        },
        {
          "parameters": {
            "conditions": {
              "string": [
                {
                  "value1": "={{ $json.intervention }}",
                  "operation": "equals",
                  "value2": "personal_outreach"
                }
              ]
            }
          },
          "id": "intervention-router",
          "name": "Route by Intervention",
          "type": "n8n-nodes-base.switch",
          "typeVersion": 3,
          "position": [850, 300]
        },
        {
          "parameters": {
            "resource": "task",
            "operation": "create",
            "title": "High-value customer at churn risk: {{ $json.first_name }} ({{ $json.email }})",
            "description": "Risk Score: {{ $json.riskScore }}/100\nRisk Level: {{ $json.riskLevel }}\nLTV: ${{ $json.lifetime_value }}\n\nRisk Factors:\n{{ $json.riskFactors.join('\\n- ') }}\n\nRecommended Action: Personal outreach call",
            "dueDate": "={{ $now.plus(2, 'days').toISO() }}"
          },
          "id": "create-sales-task",
          "name": "Create Sales Task",
          "type": "n8n-nodes-base.hubspot",
          "typeVersion": 2,
          "position": [1050, 200]
        },
        {
          "parameters": {
            "fromEmail": "={{ $env.FROM_EMAIL }}",
            "toEmail": "={{ $json.email }}",
            "subject": "We miss you, {{ $json.first_name }}! Here's something special...",
            "emailType": "html",
            "html": "<!DOCTYPE html>\n<html>\n<body style=\"font-family:Arial,sans-serif;\">\n<h1>We've noticed you've been away, {{ $json.first_name }}</h1>\n<p>We value your membership and want to make sure everything is okay.</p>\n<p>As a thank you for being part of our community, here's an exclusive offer just for you:</p>\n<div style=\"background:#D4AF37;color:#1B365D;padding:20px;border-radius:8px;text-align:center;\">\n<h2>20% OFF</h2>\n<p>Your next purchase</p>\n<p>Code: <strong>COMEBACK20</strong></p>\n</div>\n<p style=\"margin-top:20px;\">Is there anything we can help with? Reply to this email and we'll be happy to assist.</p>\n</body>\n</html>"
          },
          "id": "win-back-email",
          "name": "Send Win-Back Offer",
          "type": "n8n-nodes-base.emailSend",
          "typeVersion": 2,
          "position": [1050, 400]
        },
        {
          "parameters": {
            "url": "={{ $env.ANALYTICS_API_URL }}/track",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "event",
                  "value": "churn_intervention_sent"
                },
                {
                  "name": "customerId",
                  "value": "={{ $json.id }}"
                },
                {
                  "name": "riskScore",
                  "value": "={{ $json.riskScore }}"
                },
                {
                  "name": "intervention",
                  "value": "={{ $json.intervention }}"
                }
              ]
            }
          },
          "id": "track-intervention",
          "name": "Track Intervention",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1250, 300]
        }
      ]
    },
    {
      "id": "referral-advocacy-engine",
      "name": "Referral & Advocacy Engine",
      "description": "Transform satisfied customers into brand ambassadors with two-sided referral rewards",
      "trigger": "NPS survey completion + Purchase milestone",
      "psychology_level": ["emotional", "transcendent"],
      "expected_impact": "+37% referred customer retention",
      "nodes": [
        {
          "parameters": {
            "path": "nps-response",
            "responseMode": "responseNode"
          },
          "id": "nps-webhook",
          "name": "NPS Survey Response",
          "type": "n8n-nodes-base.webhook",
          "typeVersion": 2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "conditions": {
              "number": [
                {
                  "value1": "={{ $json.nps_score }}",
                  "operation": "largerEqual",
                  "value2": 9
                }
              ]
            }
          },
          "id": "promoter-check",
          "name": "Is Promoter (NPS >= 9)?",
          "type": "n8n-nodes-base.if",
          "typeVersion": 2,
          "position": [450, 300]
        },
        {
          "parameters": {
            "jsCode": "// Generate unique referral code and set up advocate\nconst customer = $input.first().json;\n\n// Generate memorable referral code\nconst generateCode = (name, id) => {\n  const prefix = name.substring(0, 3).toUpperCase();\n  const suffix = id.toString().slice(-4);\n  return `${prefix}${suffix}`;\n};\n\nconst referralCode = generateCode(customer.first_name, customer.customer_id);\n\n// Determine advocate tier based on previous referrals\nlet advocateTier = 'fan';\nconst previousReferrals = customer.referral_count || 0;\n\nif (previousReferrals >= 25) {\n  advocateTier = 'vip';\n} else if (previousReferrals >= 10) {\n  advocateTier = 'ambassador';\n} else if (previousReferrals >= 3) {\n  advocateTier = 'advocate';\n}\n\n// Set reward amounts based on tier\nconst REWARDS = {\n  fan: { referrer: 10, referee: 10 },\n  advocate: { referrer: 15, referee: 15 },\n  ambassador: { referrer: 20, referee: 20 },\n  vip: { referrer: 30, referee: 25 }\n};\n\nreturn [{\n  json: {\n    ...customer,\n    referralCode,\n    advocateTier,\n    previousReferrals,\n    rewards: REWARDS[advocateTier],\n    referralLink: `${$env.APP_URL}/r/${referralCode}`,\n    createdAt: new Date().toISOString()\n  }\n}];"
          },
          "id": "setup-advocate",
          "name": "Setup Advocate Profile",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [650, 200]
        },
        {
          "parameters": {
            "fromEmail": "={{ $env.FROM_EMAIL }}",
            "toEmail": "={{ $json.email }}",
            "subject": "Thank you for the love! Share it with friends üíõ",
            "emailType": "html",
            "html": "<!DOCTYPE html>\n<html>\n<body style=\"font-family:Arial,sans-serif;background:#f9f9f9;padding:20px;\">\n<div style=\"max-width:600px;margin:0 auto;background:#ffffff;padding:30px;border-radius:8px;\">\n<h1 style=\"color:#1B365D;\">You're amazing, {{ $json.first_name }}! üåü</h1>\n<p>We're so grateful for your support and kind words. Customers like you are why we do what we do.</p>\n\n<div style=\"background:#1B365D;color:#ffffff;padding:25px;border-radius:8px;text-align:center;margin:20px 0;\">\n<h2 style=\"color:#D4AF37;margin-top:0;\">Share the Love</h2>\n<p>Give your friends ${{ $json.rewards.referee }} off their first order</p>\n<p>You'll get ${{ $json.rewards.referrer }} for each friend who joins!</p>\n<div style=\"background:#ffffff;color:#1B365D;padding:15px;border-radius:4px;font-size:24px;font-weight:bold;margin:15px 0;\">\n{{ $json.referralCode }}\n</div>\n<a href=\"{{ $json.referralLink }}\" style=\"display:inline-block;background:#D4AF37;color:#1B365D;padding:12px 24px;text-decoration:none;border-radius:4px;font-weight:bold;\">Share Your Link</a>\n</div>\n\n<p style=\"color:#666;font-size:14px;\">You're a {{ $json.advocateTier | title }} with {{ $json.previousReferrals }} successful referrals!</p>\n</div>\n</body>\n</html>"
          },
          "id": "referral-invitation",
          "name": "Send Referral Invitation",
          "type": "n8n-nodes-base.emailSend",
          "typeVersion": 2,
          "position": [850, 200]
        },
        {
          "parameters": {
            "operation": "executeQuery",
            "query": "INSERT INTO referral_codes (customer_id, code, advocate_tier, rewards_referrer, rewards_referee, created_at) VALUES ('{{ $json.customer_id }}', '{{ $json.referralCode }}', '{{ $json.advocateTier }}', {{ $json.rewards.referrer }}, {{ $json.rewards.referee }}, NOW()) ON CONFLICT (customer_id) DO UPDATE SET advocate_tier = '{{ $json.advocateTier }}', rewards_referrer = {{ $json.rewards.referrer }}, rewards_referee = {{ $json.rewards.referee }}, updated_at = NOW();"
          },
          "id": "save-referral-code",
          "name": "Save Referral Code",
          "type": "n8n-nodes-base.postgres",
          "typeVersion": 2,
          "position": [1050, 200]
        },
        {
          "parameters": {
            "url": "={{ $env.ANALYTICS_API_URL }}/track",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "event",
                  "value": "advocate_activated"
                },
                {
                  "name": "customerId",
                  "value": "={{ $json.customer_id }}"
                },
                {
                  "name": "npsScore",
                  "value": "={{ $json.nps_score }}"
                },
                {
                  "name": "advocateTier",
                  "value": "={{ $json.advocateTier }}"
                }
              ]
            }
          },
          "id": "track-advocate",
          "name": "Track Advocate Activation",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1250, 200]
        }
      ]
    },
    {
      "id": "personalization-engine",
      "name": "AI Personalization Engine",
      "description": "ML-powered content and offer personalization based on behavior and preferences",
      "trigger": "User interaction events",
      "psychology_level": ["behavioral", "emotional"],
      "expected_impact": "91% consumer preference for personalized experiences",
      "nodes": [
        {
          "parameters": {
            "path": "user-interaction",
            "responseMode": "responseNode"
          },
          "id": "interaction-webhook",
          "name": "User Interaction",
          "type": "n8n-nodes-base.webhook",
          "typeVersion": 2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "jsCode": "// Feature extraction for personalization\nconst interaction = $input.first().json;\n\n// Calculate RFM (Recency, Frequency, Monetary) scores\nconst rfmScore = {\n  recency: interaction.days_since_last_purchase <= 7 ? 5 :\n           interaction.days_since_last_purchase <= 14 ? 4 :\n           interaction.days_since_last_purchase <= 30 ? 3 :\n           interaction.days_since_last_purchase <= 60 ? 2 : 1,\n  \n  frequency: interaction.purchase_count_90d >= 10 ? 5 :\n             interaction.purchase_count_90d >= 6 ? 4 :\n             interaction.purchase_count_90d >= 3 ? 3 :\n             interaction.purchase_count_90d >= 1 ? 2 : 1,\n  \n  monetary: interaction.total_spend_90d >= 500 ? 5 :\n            interaction.total_spend_90d >= 200 ? 4 :\n            interaction.total_spend_90d >= 100 ? 3 :\n            interaction.total_spend_90d >= 50 ? 2 : 1\n};\n\n// Behavioral signals\nconst behaviors = {\n  browsingCategories: interaction.recent_categories || [],\n  searchTerms: interaction.recent_searches || [],\n  cartAbandonment: interaction.abandoned_cart_items || [],\n  wishlistItems: interaction.wishlist_items || [],\n  viewedProducts: interaction.recently_viewed || []\n};\n\n// Contextual signals\nconst context = {\n  device: interaction.device_type,\n  location: interaction.geo_region,\n  timeOfDay: new Date().getHours(),\n  dayOfWeek: new Date().getDay(),\n  sessionDepth: interaction.pages_viewed_session\n};\n\n// Determine personalization strategy\nlet strategy = 'general';\nif (behaviors.cartAbandonment.length > 0) {\n  strategy = 'cart_recovery';\n} else if (behaviors.wishlistItems.length > 0) {\n  strategy = 'wishlist_promotion';\n} else if (rfmScore.recency <= 2 && rfmScore.frequency >= 3) {\n  strategy = 'reactivation';\n} else if (rfmScore.frequency >= 4) {\n  strategy = 'loyalty_reward';\n}\n\nreturn [{\n  json: {\n    customerId: interaction.customer_id,\n    rfmScore,\n    behaviors,\n    context,\n    strategy,\n    extractedAt: new Date().toISOString()\n  }\n}];"
          },
          "id": "feature-extraction",
          "name": "Extract Features",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [450, 300]
        },
        {
          "parameters": {
            "url": "={{ $env.ML_API_URL }}/recommendations",
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ JSON.stringify({ customer_id: $json.customerId, rfm: $json.rfmScore, behaviors: $json.behaviors, context: $json.context, limit: 6 }) }}",
            "options": {
              "timeout": 5000
            }
          },
          "id": "ml-recommendations",
          "name": "Get ML Recommendations",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [650, 300],
          "continueOnFail": true
        },
        {
          "parameters": {
            "jsCode": "// Assemble personalized content\nconst data = $input.first().json;\nconst recommendations = data.recommendations || [];\n\n// Select content template based on strategy\nconst templates = {\n  cart_recovery: {\n    subject: 'You left something behind! Complete your order',\n    headline: 'Your cart is waiting',\n    cta: 'Complete Purchase'\n  },\n  wishlist_promotion: {\n    subject: 'Good news about items on your wishlist!',\n    headline: 'Wishlist items on sale',\n    cta: 'Shop Your Wishlist'\n  },\n  reactivation: {\n    subject: 'We miss you! Here\\'s something special',\n    headline: 'Welcome back offer',\n    cta: 'Explore What\\'s New'\n  },\n  loyalty_reward: {\n    subject: 'Thank you for being a loyal customer!',\n    headline: 'Exclusive for you',\n    cta: 'Claim Your Reward'\n  },\n  general: {\n    subject: 'Picked just for you',\n    headline: 'Recommendations for you',\n    cta: 'Shop Now'\n  }\n};\n\nconst template = templates[data.strategy] || templates.general;\n\n// Build personalized product grid\nconst productGrid = recommendations.slice(0, 6).map(p => ({\n  id: p.product_id,\n  name: p.name,\n  price: p.price,\n  image: p.image_url,\n  reason: p.recommendation_reason\n}));\n\nreturn [{\n  json: {\n    customerId: data.customerId,\n    strategy: data.strategy,\n    template,\n    productGrid,\n    personalizedAt: new Date().toISOString()\n  }\n}];"
          },
          "id": "content-assembler",
          "name": "Assemble Content",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [850, 300]
        },
        {
          "parameters": {
            "url": "={{ $env.SEND_TIME_API }}/optimal-time",
            "sendBody": true,
            "bodyParameters": {
              "parameters": [
                {
                  "name": "customerId",
                  "value": "={{ $json.customerId }}"
                }
              ]
            }
          },
          "id": "delivery-optimizer",
          "name": "Optimize Send Time",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1050, 300],
          "continueOnFail": true
        },
        {
          "parameters": {
            "url": "={{ $env.EMAIL_QUEUE_API }}/schedule",
            "sendBody": true,
            "specifyBody": "json",
            "jsonBody": "={{ JSON.stringify({ customer_id: $json.customerId, template: $json.template, products: $json.productGrid, send_at: $json.optimal_send_time || null }) }}"
          },
          "id": "schedule-send",
          "name": "Schedule Personalized Email",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4,
          "position": [1250, 300]
        }
      ]
    }
  ],
  "environment_variables": {
    "required": [
      "FROM_EMAIL",
      "BRAND_NAME",
      "APP_URL",
      "CRM_API_URL",
      "ANALYTICS_API_URL"
    ],
    "optional": [
      "ENRICHMENT_API_URL",
      "ML_API_URL",
      "SEND_TIME_API",
      "EMAIL_QUEUE_API"
    ]
  },
  "best_practices": {
    "error_handling": "All external API calls should use continueOnFail with fallback logic",
    "rate_limiting": "Implement throttling for high-volume workflows (100 req/min default)",
    "idempotency": "Design all nodes to be safely retryable",
    "monitoring": "Add analytics tracking to measure workflow performance",
    "testing": "Use staging environment with test data before production"
  }
}
